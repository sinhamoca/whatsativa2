// modules/module_dreamtv.js - M√≥dulo de Ativa√ß√£o DreamTV
const axios = require('axios');

class DreamTVActivator {
    constructor(config = {}) {
        this.config = {
            name: 'DreamTV',
            version: '1.0.1',
            baseUrl: 'https://api.dreamtv.life',
            email: config.email || 'isaacdopanta@gmail.com',
            password: config.password || '10203040',
            defaultPackageId: config.defaultPackageId || 3,
            timeout: config.timeout || 15000,
            ...config
        };
        
        this.accessToken = null;
        this.stats = {
            activations: 0,
            successes: 0,
            failures: 0
        };
        
        // Configurar axios
        this.api = axios.create({
            baseURL: this.config.baseUrl,
            timeout: this.config.timeout,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json, text/plain, */*',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
        });
    }

    /**
     * üîê Fazer login e obter token JWT
     */
    async login() {
        try {
            console.log('üîê Fazendo login no DreamTV...');
            
            const response = await this.api.post('/reseller/login', {
                email: this.config.email,
                password: this.config.password
            });

            if (response.data.error === false && response.data.message) {
                this.accessToken = response.data.message;
                console.log('‚úÖ Login realizado com sucesso');
                return { success: true, token: this.accessToken };
            } else {
                throw new Error('Resposta de login inv√°lida');
            }

        } catch (error) {
            console.error('‚ùå Erro no login:', error.message);
            return {
                success: false,
                error: 'Erro no login DreamTV',
                details: error.response?.data || error.message
            };
        }
    }

    /**
     * üì± Ativar dispositivo - M√âTODO PRINCIPAL CORRIGIDO
     */
    async activateDevice(macAddress, packageId = null, order = {}) {
        try {
            // Validar MAC address
            if (!this.isValidMacAddress(macAddress)) {
                return {
                    success: false,
                    error: 'MAC address inv√°lido',
                    details: 'Formato deve ser XX:XX:XX:XX:XX:XX'
                };
            }

            // Fazer login se necess√°rio
            if (!this.accessToken) {
                const loginResult = await this.login();
                if (!loginResult.success) {
                    return loginResult;
                }
            }

            // Normalizar MAC address (manter formato com dois pontos)
            const normalizedMac = this.normalizeMacAddress(macAddress);
            const finalPackageId = packageId || this.config.defaultPackageId;

            console.log(`üì° Ativando: ${normalizedMac} com pacote ${finalPackageId}`);

            // CORRE√á√ÉO PRINCIPAL: Usar endpoint correto com Bearer token
            const response = await this.api.post('/reseller/activate', {
                mac: normalizedMac,
                package_id: finalPackageId
            }, {
                headers: {
                    'Authorization': `Bearer ${this.accessToken}`, // ‚úÖ CORRE√á√ÉO: Bearer token
                    'Content-Type': 'application/json'
                }
            });

            // CORRE√á√ÉO: Status de sucesso √© 201 (n√£o 200)
            if (response.status === 201 && response.data.error === false) {
                console.log('‚úÖ Dispositivo ativado com sucesso');
                
                this.stats.successes++;
                
                return {
                    success: true,
                    message: 'Dispositivo ativado com sucesso',
                    data: {
                        mac: normalizedMac,
                        packageId: finalPackageId,
                        response: response.data,
                        // Dados reais da API
                        deviceId: response.data.message.device_id,
                        activationId: response.data.message.id,
                        activatedUntil: response.data.message.activated_until,
                        packageName: response.data.message.package_name,
                        price: response.data.message.price
                    }
                };
            } else {
                throw new Error(`Status inesperado: ${response.status}`);
            }

        } catch (error) {
            console.error('‚ùå Erro na ativa√ß√£o:', error.message);
            
            this.stats.failures++;
            
            // Verificar se √© erro de token expirado
            if (error.response?.status === 401) {
                console.log('üîÑ Token expirado, tentando renovar...');
                this.accessToken = null;
                
                // Tentar uma vez mais
                const loginResult = await this.login();
                if (loginResult.success) {
                    return await this.activateDevice(macAddress, packageId, order);
                }
            }

            return {
                success: false,
                error: 'Erro na ativa√ß√£o DreamTV',
                details: error.response?.data || error.message
            };
        }
    }

    /**
     * üìù M√©todo principal de ativa√ß√£o (interface padr√£o)
     */
    async activate(activationData, order = {}) {
        try {
            this.stats.activations++;
            
            // Extrair dados necess√°rios
            const { macAddress, packageId } = this.extractActivationData(activationData);
            
            // Executar ativa√ß√£o
            const result = await this.activateDevice(macAddress, packageId, order);
            
            if (result.success) {
                return {
                    success: true,
                    result: this.formatSuccessMessage(result, order), // ‚úÖ Mantido 'result' como no original
                    data: result.data
                };
            } else {
                return {
                    success: false,
                    error: result.error,
                    message: this.formatErrorMessage(result.error)
                };
            }

        } catch (error) {
            console.error('‚ùå Erro geral na ativa√ß√£o:', error);
            return {
                success: false,
                error: 'Erro interno',
                details: error.message
            };
        }
    }

    /**
     * üìä Extrair dados de ativa√ß√£o
     */
    extractActivationData(activationData) {
        let macAddress = null;
        let packageId = this.config.defaultPackageId;

        if (typeof activationData === 'string') {
            // Se √© uma string, assumir que √© o MAC address
            macAddress = activationData;
        } else if (typeof activationData === 'object') {
            macAddress = activationData.macAddress || 
                        activationData.mac || 
                        activationData.serial || 
                        activationData.device_id;
            packageId = activationData.packageId || 
                       activationData.package_id || 
                       packageId;
        }

        return { macAddress, packageId };
    }

    /**
     * üì¶ Obter informa√ß√µes do pacote
     */
    getPackageInfo(packageId) {
        const packages = {
            1: { name: 'Mensal', days: 30 },
            2: { name: 'Trimestral', days: 90 },
            3: { name: 'Anual', days: 365 }
        };
        
        return packages[packageId] || packages[3]; // Padr√£o anual
    }

    /**
     * ‚úÖ Formatar mensagem de sucesso - MELHORADA
     */
    formatSuccessMessage(result, order = {}) {
        // Usar dados reais da API quando dispon√≠veis
        const activatedUntil = result.data.activatedUntil ? 
            new Date(result.data.activatedUntil) : 
            new Date(Date.now() + (365 * 24 * 60 * 60 * 1000)); // 1 ano default
            
        const dataAtual = new Date();
        const dataAtivacao = dataAtual.toLocaleDateString('pt-BR');
        const dataExpiracao = activatedUntil.toLocaleDateString('pt-BR');
        
        let message = 'üéâ *DREAMTV ATIVADO COM SUCESSO!*\n\n';
        message += 'üì∫ *Plataforma:* DreamTV Premium\n';
        message += 'üì± *MAC Ativado:* `' + result.data.mac + '`\n';
        message += 'üìÖ *Data Ativa√ß√£o:* ' + dataAtivacao + '\n';
        message += '‚è∞ *V√°lido at√©:* ' + dataExpiracao + '\n';
        
        // Usar nome real do pacote da API se dispon√≠vel
        if (result.data.packageName) {
            message += 'üì¶ *Pacote:* ' + result.data.packageName + '\n';
        } else {
            const packageInfo = this.getPackageInfo(result.data.packageId);
            message += 'üì¶ *Pacote:* ' + packageInfo.name + ' (' + packageInfo.days + ' dias)\n';
        }
        
        // Mostrar pre√ßo se dispon√≠vel
        if (result.data.price) {
            message += 'üí∞ *Valor:* R$ ' + result.data.price + '\n';
        }
        
        message += '\nüî• *Seu DreamTV est√° pronto para usar!*\n\n';
        message += 'üîÑ Digite *menu* para nova ativa√ß√£o';
        
        return message;
    }

    /**
     * ‚ùå Formatar mensagem de erro
     */
    formatErrorMessage(error) {
        let message = '‚ùå *ERRO NA ATIVA√á√ÉO DREAMTV*\n\n';
        message += 'üö® *Motivo:* ' + error + '\n\n';
        message += 'üí° *Solu√ß√µes:*\n';
        message += '‚Ä¢ Verifique o MAC address\n';
        message += '‚Ä¢ Tente novamente em alguns minutos\n';
        message += '‚Ä¢ Entre em contato com o suporte\n\n';
        message += 'üîÑ Digite *menu* para tentar novamente';
        
        return message;
    }

    /**
     * üß™ M√©todo de teste - MELHORADO
     */
    async test() {
        try {
            console.log('üß™ Iniciando teste do DreamTV...');
            
            // Teste 1: Login
            console.log('üîê Testando login...');
            const loginResult = await this.login();
            if (!loginResult.success) {
                return {
                    success: false,
                    error: 'Falha no teste de login',
                    details: loginResult.error
                };
            }

            // Teste 2: Ativa√ß√£o com MAC realista (n√£o 00:00:00:00:00:00)
            console.log('üì° Testando ativa√ß√£o com MAC v√°lido...');
            const testMac = 'aa:bb:cc:dd:ee:ff'; // MAC mais realista
            const activationResult = await this.activateDevice(testMac);
            
            console.log('üìä Resultado da ativa√ß√£o de teste:', activationResult);
            
            return {
                success: true,
                message: 'Teste conclu√≠do com sucesso',
                tests: {
                    login: loginResult.success,
                    activation: activationResult.success,
                    token: !!this.accessToken
                }
            };

        } catch (error) {
            return {
                success: false,
                error: 'Erro no teste',
                details: error.message
            };
        }
    }

    /**
     * üîß Validar MAC address
     */
    isValidMacAddress(mac) {
        if (!mac || typeof mac !== 'string') return false;
        
        // Remover espa√ßos e converter para mai√∫scula
        mac = mac.trim().toUpperCase();
        
        // Aceitar formatos: XX:XX:XX:XX:XX:XX, XX-XX-XX-XX-XX-XX, XXXXXXXXXXXX
        const patterns = [
            /^([0-9A-F]{2}[:-]){5}([0-9A-F]{2})$/, // XX:XX:XX:XX:XX:XX ou XX-XX-XX-XX-XX-XX
            /^[0-9A-F]{12}$/ // XXXXXXXXXXXX
        ];
        
        return patterns.some(pattern => pattern.test(mac));
    }

    /**
     * üîß Normalizar MAC address - CORRIGIDO
     */
    normalizeMacAddress(mac) {
        if (!mac) return 'aa:bb:cc:dd:ee:ff'; // MAC realista para teste
        
        // Remover espa√ßos e converter para MIN√öSCULA (API prefere)
        let normalized = mac.trim().toLowerCase();
        
        // Se n√£o tem separadores, adicionar
        if (normalized.length === 12 && !normalized.includes(':') && !normalized.includes('-')) {
            normalized = normalized.match(/.{2}/g).join(':');
        }
        
        // Converter separadores para dois pontos
        normalized = normalized.replace(/-/g, ':');
        
        // ‚úÖ MANTER formato com dois pontos (n√£o remover!)
        return normalized;
    }

    /**
     * üìä Obter estat√≠sticas
     */
    getStats() {
        return {
            ...this.stats,
            successRate: this.stats.activations > 0 
                ? ((this.stats.successes / this.stats.activations) * 100).toFixed(2) + '%'
                : '0%',
            hasToken: !!this.accessToken
        };
    }

    /**
     * üîÑ Resetar token (for√ßar novo login)
     */
    resetToken() {
        this.accessToken = null;
        console.log('üîÑ Token resetado');
    }
}

/**
 * Fun√ß√£o de f√°brica para criar inst√¢ncia
 */
function createActivator(config = {}) {
    return new DreamTVActivator(config);
}

// Exportar
module.exports = {
    DreamTVActivator,
    createActivator
};

// Teste direto se executado
if (require.main === module) {
    const activator = createActivator();
    activator.test().then(result => {
        console.log('\n=== RESULTADO DO TESTE DREAMTV ===');
        console.log('Status:', result.success ? '‚úÖ SUCESSO' : '‚ùå FALHA');
        if (result.success) {
            console.log('Testes:', result.tests);
        } else {
            console.log('Erro:', result.error);
            console.log('Detalhes:', result.details);
        }
        console.log('Estat√≠sticas:', activator.getStats());
        console.log('=================================\n');
    }).catch(error => {
        console.error('‚ùå Erro no teste:', error);
    });
}
