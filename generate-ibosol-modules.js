// generate-ibosol-modules.js - Gera todos os m√≥dulos IboSol automaticamente
const fs = require('fs');
const path = require('path');

// Configura√ß√£o de todos os aplicativos
const appsConfig = {
    "IBOPLAYER": { 
        id: 1, 
        name: "IBO Player", 
        price: 89.90,
        description: "Ativa√ß√£o do IBO Player - Aplicativo de streaming premium"
    },
    "ABEPlayerTv": { 
        id: 2, 
        name: "ABE Player TV", 
        price: 79.90,
        description: "Ativa√ß√£o do ABE Player TV - Streaming de alta qualidade"
    },
    "BOBPLAYER": { 
        id: 3, 
        name: "BOB Player", 
        price: 69.90,
        description: "Ativa√ß√£o do BOB Player - Player multifuncional"
    },
    "MACPLAYER": { 
        id: 4, 
        name: "MAC Player", 
        price: 79.90,
        description: "Ativa√ß√£o do MAC Player - Compat√≠vel com MAC Address"
    },
    "VIRGINIA": { 
        id: 5, 
        name: "Virginia Player", 
        price: 74.90,
        description: "Ativa√ß√£o do Virginia Player - Streaming avan√ßado"
    },
    "AllPlayer": { 
        id: 6, 
        name: "All Player", 
        price: 84.90,
        description: "Ativa√ß√£o do All Player - Player universal"
    },
    "HUSHPLAY": { 
        id: 7, 
        name: "Hush Play", 
        price: 72.90,
        description: "Ativa√ß√£o do Hush Play - Streaming discreto"
    },
    "KTNPLAYER": { 
        id: 8, 
        name: "KTN Player", 
        price: 77.90,
        description: "Ativa√ß√£o do KTN Player - Player profissional"
    },
    "FAMILYPLAYER": { 
        id: 9, 
        name: "Family Player", 
        price: 82.90,
        description: "Ativa√ß√£o do Family Player - Ideal para fam√≠lia"
    },
    "IBOSSPLAYER": { 
        id: 10, 
        name: "IBoss Player", 
        price: 94.90,
        description: "Ativa√ß√£o do IBoss Player - Player empresarial"
    },
    "KING4KPLAYER": { 
        id: 11, 
        name: "King 4K Player", 
        price: 99.90,
        description: "Ativa√ß√£o do King 4K Player - Qualidade 4K premium"
    },
    "IBOSTB": { 
        id: 12, 
        name: "IBO STB", 
        price: 89.90,
        description: "Ativa√ß√£o do IBO STB - Set-top box virtual"
    },
    "IBOXXPLAYER": { 
        id: 13, 
        name: "IboXX Player", 
        price: 87.90,
        description: "Ativa√ß√£o do IboXX Player - Player avan√ßado"
    },
    "DUPLEX24": { 
        id: 14, 
        name: "Duplex 24", 
        price: 91.90,
        description: "Ativa√ß√£o do Duplex 24 - Streaming 24h"
    },
    "BOBPRO": { 
        id: 15, 
        name: "BOB Pro", 
        price: 97.90,
        description: "Ativa√ß√£o do BOB Pro - Vers√£o profissional"
    },
    "BOBPREMIUM": { 
        id: 16, 
        name: "BOB Premium", 
        price: 104.90,
        description: "Ativa√ß√£o do BOB Premium - Vers√£o premium"
    },
    "IBOSOLPlayer": { 
        id: 17, 
        name: "IBOSol Player", 
        price: 92.90,
        description: "Ativa√ß√£o do IBOSol Player - Player oficial"
    },
    "FLIXNET": { 
        id: 18, 
        name: "FlixNet", 
        price: 85.90,
        description: "Ativa√ß√£o do FlixNet - Streaming de filmes"
    },
    "SMARTONEPRO": { 
        id: 19, 
        name: "Smart One Pro", 
        price: 96.90,
        description: "Ativa√ß√£o do Smart One Pro - Player inteligente"
    }
};

/**
 * Gera um m√≥dulo espec√≠fico para um app
 */
function generateModuleFile(appModule, appConfig) {
    const moduleId = appModule.toLowerCase().replace(/[^a-z0-9]/g, '_');
    const className = appModule.replace(/[^a-zA-Z0-9]/g, '') + 'Activator';
    
    return `// modules/module_${moduleId}.js - M√≥dulo ${appConfig.name}
const IboSolBaseActivator = require('./ibosol-base-activator');

class ${className} extends IboSolBaseActivator {
    constructor(config = {}) {
        super({
            name: '${appConfig.name}',
            appModule: '${appModule}',
            appId: ${appConfig.id},
            email: config.email || 'isaacdopanta@gmail.com',
            password: config.password || 'P@pangu1',
            ...config
        });
    }
}

/**
 * Fun√ß√£o de f√°brica para criar inst√¢ncia
 */
function createActivator(config = {}) {
    return new ${className}(config);
}

// Exportar
module.exports = {
    ${className},
    createActivator
};

// Teste direto se executado
if (require.main === module) {
    const activator = createActivator();
    activator.test().then(result => {
        console.log('\\n=== RESULTADO DO TESTE ${appConfig.name} ===');
        console.log('Status:', result.success ? '‚úÖ SUCESSO' : '‚ùå FALHA');
        console.log('App ID:', result.appId);
        console.log('App Module:', result.appModule);
        if (result.success) {
            console.log('Login funcionando:', result.loginWorking);
        } else {
            console.log('Erro:', result.error);
        }
        console.log('================================\\n');
    }).catch(error => {
        console.error('‚ùå Erro no teste:', error);
    });
}
`;
}

/**
 * Gera todos os m√≥dulos
 */
function generateAllModules() {
    console.log('üöÄ GERANDO M√ìDULOS IBOSOL');
    console.log('‚ïê'.repeat(50));
    
    const modulesDir = './modules';
    
    // Criar diret√≥rio se n√£o existir
    if (!fs.existsSync(modulesDir)) {
        fs.mkdirSync(modulesDir, { recursive: true });
        console.log('üìÅ Diret√≥rio modules/ criado');
    }
    
    let generatedCount = 0;
    
    // Gerar cada m√≥dulo
    Object.entries(appsConfig).forEach(([appModule, appConfig]) => {
        const moduleId = appModule.toLowerCase().replace(/[^a-z0-9]/g, '_');
        const fileName = `module_${moduleId}.js`;
        const filePath = path.join(modulesDir, fileName);
        
        try {
            const moduleContent = generateModuleFile(appModule, appConfig);
            fs.writeFileSync(filePath, moduleContent);
            
            console.log(`‚úÖ ${fileName} - ${appConfig.name} (ID: ${appConfig.id})`);
            generatedCount++;
            
        } catch (error) {
            console.error(`‚ùå Erro ao gerar ${fileName}:`, error.message);
        }
    });
    
    console.log('‚ïê'.repeat(50));
    console.log(`üéâ ${generatedCount} m√≥dulos gerados com sucesso!`);
    
    return generatedCount;
}

/**
 * Gera script para adicionar produtos ao banco
 */
function generateProductsScript() {
    console.log('üìù Gerando script de produtos...');
    
    const productsArray = Object.entries(appsConfig).map(([appModule, appConfig]) => {
        const moduleId = appModule.toLowerCase().replace(/[^a-z0-9]/g, '_');
        return {
            id: moduleId,
            name: appConfig.name,
            description: appConfig.description,
            price: appConfig.price,
            currency: 'BRL',
            activationModule: moduleId,
            paymentConfirmedMessage: `üéâ *${appConfig.name.toUpperCase()} - PAGAMENTO CONFIRMADO!*

üéØ *Produto:* {product_name}
üí∞ *Valor pago:* R$ {price}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìù *AGORA PRECISO DAS INFORMA√á√ïES:*

Para ativar seu ${appConfig.name}, envie o **MAC Address** do seu dispositivo.

üìç *Como encontrar o MAC:*
‚Ä¢ Android TV: Configura√ß√µes > Sobre > Status
‚Ä¢ Fire TV: Configura√ß√µes > Minha Fire TV > Sobre  
‚Ä¢ Smart TV: Configura√ß√µes > Rede > Status da Rede

üì§ *Exemplo:* AA:BB:CC:DD:EE:FF

‚ö° Envie apenas o MAC que ativo imediatamente!`,
            active: true
        };
    });
    
    const scriptContent = `// add-all-ibosol-products.js - Adiciona todos os produtos IboSol
const DatabaseService = require('./database-service');

const products = ${JSON.stringify(productsArray, null, 2)};

async function addAllProducts() {
    const db = new DatabaseService('./database.sqlite');
    
    try {
        console.log('üîå Conectando ao banco...');
        await db.initialize();
        
        console.log(\`üì± Adicionando \${products.length} produtos IboSol...\`);
        
        for (const product of products) {
            try {
                await db.saveProduct(product);
                console.log(\`‚úÖ \${product.name} - R$ \${product.price}\`);
            } catch (error) {
                console.error(\`‚ùå Erro ao adicionar \${product.name}:\`, error.message);
            }
        }
        
        console.log('\\nüéâ Todos os produtos adicionados!');
        await db.close();
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        await db.close();
        process.exit(1);
    }
}

if (require.main === module) {
    addAllProducts().catch(console.error);
}

module.exports = { addAllProducts, products };
`;

    fs.writeFileSync('./add-all-ibosol-products.js', scriptContent);
    console.log('‚úÖ Script add-all-ibosol-products.js criado');
}

/**
 * Gera lista de produtos para refer√™ncia
 */
function generateProductsList() {
    console.log('\nüìã LISTA DE PRODUTOS GERADOS:');
    console.log('‚ïê'.repeat(60));
    
    Object.entries(appsConfig).forEach(([appModule, appConfig]) => {
        const moduleId = appModule.toLowerCase().replace(/[^a-z0-9]/g, '_');
        console.log(`${appConfig.id.toString().padStart(2, '0')}. ${appConfig.name.padEnd(20)} - R$ ${appConfig.price.toFixed(2)} - ${moduleId}`);
    });
    
    console.log('‚ïê'.repeat(60));
}

/**
 * Executar gera√ß√£o completa
 */
function generateComplete() {
    console.log('üéØ GERA√á√ÉO COMPLETA DE M√ìDULOS IBOSOL');
    console.log('‚îÅ'.repeat(60));
    
    // 1. Gerar m√≥dulos
    const modulesCount = generateAllModules();
    
    // 2. Gerar script de produtos
    generateProductsScript();
    
    // 3. Mostrar lista
    generateProductsList();
    
    console.log('\nüöÄ PR√ìXIMOS PASSOS:');
    console.log('1. Copie o arquivo ibosol-base-activator.js para a pasta modules/');
    console.log('2. Execute: node add-all-ibosol-products.js');
    console.log('3. Reinicie o sistema: pm2 restart all');
    console.log('4. Teste no WhatsApp digitando "menu"');
    
    console.log('\nüí° ESTRUTURA CRIADA:');
    console.log('üìÅ modules/');
    console.log('   ‚îú‚îÄ‚îÄ ibosol-base-activator.js (m√≥dulo base)');
    Object.entries(appsConfig).forEach(([appModule, appConfig]) => {
        const moduleId = appModule.toLowerCase().replace(/[^a-z0-9]/g, '_');
        console.log(`   ‚îú‚îÄ‚îÄ module_${moduleId}.js`);
    });
    console.log('üìÑ add-all-ibosol-products.js (script para adicionar produtos)');
    
    return {
        modulesGenerated: modulesCount,
        totalApps: Object.keys(appsConfig).length
    };
}

// Executar se chamado diretamente
if (require.main === module) {
    const result = generateComplete();
    
    console.log('\nüéâ GERA√á√ÉO CONCLU√çDA!');
    console.log(`üì¶ ${result.modulesGenerated} de ${result.totalApps} m√≥dulos criados`);
}

module.exports = {
    generateAllModules,
    generateProductsScript,
    generateProductsList,
    generateComplete,
    appsConfig
};
